# kubernetes 集群 CNI 网络规划


- 专有网络网段 

  节点所在集群所处的子网网段，例如阿里云的 VPC 网段。

- node 交换机网段

  - 节点所绑定的交换机分配的网段，用于节点间网络通信。
  - 必须属于专有网络网段内，即 node 虚拟机自身拥有的固定 IP 所在网段，可区分为不同环境或可用区。

- Pod 网络CIDR网段

  Pod地址从该地址段分配，用于Pod网络通信，每个Pod具有一个独立不固定的IP地址。
  
  - flannel
    - L3 overlay 存在NAT转换，需要有独立虚拟网段，非虚拟交换机网段，网段不能和虚拟交换机网段或Service CIDR网段重叠。
    - 如 VPC网段用的是172.16.0.0/12，Kubernetes的Pod地址段就不能使用172.16.0.0/16、172.17.0.0/16等，因为这些地址都包含在172.16.0.0/12里。
    - 容易造成 IP 浪费，需注意提前划分
    - 需要和 kube-proxy clusterCIDR 配置一致
    - 同节点内 pod 通过 L2 网桥通信，跨节点不同节点间分配一个独立子网，通过 L3 经过 flanneld 维护在 etcd 中的路由表通信
  
  - terway
    - L2 二层转发，通过弹性网卡（ENI）接入虚拟交换机，来组建 Pod 网络。
    - Pod分配的 Pod IP从 Pod 网络 CIDR 网段内获取，独立绑定 pod 虚拟交换机
    - pod 虚拟交换机网段需要和 node 交换机网段能 L2 相互通信，即在同一个 VPC 子网内通信不经过三层转换。
    - 不同 ECS 规格所能支持挂载的弹性网卡数量不同，而 ECS 挂载弹性网卡的数量以及单个弹性网卡支持的 IP 数量直接决定了节点所能分配的 Pod 数量，因此在选择节点规格时需要注意 Pod 数量限制。
    - 每个Pod都拥有自己网络栈和IP地址。同一台ECS内的Pod之间通信，直接通过机器内部的转发，跨ECS的Pod通信、报文通过VPC的弹性网卡直接转发，少了封包拆包。
    
  
- Service CIDR网段
  
  kubernetes 集群内，Service 类型为 ClusterIP 时 Service 使用的 VIP 地址，每个Service有自己的地址。
  
  - 只在Kubernetes集群内使用，不能在集群外使用
  - 独立网段，不能和 node 交换机地址重叠，不能和 pod 网络 CIDR 地址重叠



| CNI 插件 | 专有网络网段         | node交换机网段         | Pod网络CIDR网段        | Service CIDR网段     | 最大可分配Pod地址数 | 可用节点数（48 Pod每节点 4c32GB） | 可用节点数（143 Pod每节点 16c128GB）  | 微服务数量 |
|---------|--------------------|----------------------|-----------------------|---------------------|------------------|-------------------------------|-----------------------------------|-----------|
| flannel | 192.168.126.0/24   | 192.168.126.0/24 256 | 10.244.0.0/16  65536  | 10.96.0.0/12   209w | 65536            |   1365                        | 512                               |  209w     |
| terway  | 172.18.0.0/16      | 172.18.41.0/24   256 | 172.18.160.0/20  4096 | 172.23.0.0/20  4096 | 4096             |   85                          | 28                                |  4096     |
|         |                    | 172.18.42.0/24   256 | 172.18.176.0/20  4096 |                     | 4096             |   85                          | 28                                |           |


flannel CNI 默认配置节点信信息（按默认的网段分配，会有 IP 地址浪费）

| CNI 插件 | node IP            | 节点Pod网络CIDR网段     | 最大可分配Pod地址数（按默认） | 可用 pod 数（48 Pod每节点 4c32GB） | 可用 pod 数（143 Pod每节点 16c128GB）  |
|---------|--------------------|-----------------------|--------------------------|---------------------------------|-------------------------------------|
| flannel | 192.168.126.137    | 10.244.0.0/24   256   | 110                      | 48                              |   143                               |
|         | 192.168.126.140    | 10.244.1.0/24   256   | 110                      | 48                              |   143                               |
|         | 192.168.126.141    | 10.244.2.0/24   256   | 110                      | 48                              |   143                               |

